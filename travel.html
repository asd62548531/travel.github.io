<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>旅人手札 - 旅遊計劃書 (升級版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 手機版優化 */
        body { -webkit-tap-highlight-color: transparent; background-color: #f3f4f6; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .tab-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; font-weight: bold; }
        .card-shadow { box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .input-time-24h::-webkit-calendar-picker-indicator { filter: invert(0.5); }
    </style>
</head>
<body class="text-gray-700 h-screen flex flex-col overflow-hidden">

<div id="app" class="flex flex-col h-full">

    <header class="bg-white p-4 shadow-sm z-10 flex justify-between items-center shrink-0">
        <h1 class="text-xl font-bold text-blue-600"><i class="fa-solid fa-plane-departure mr-2"></i>旅人手札</h1>
        <button @click="isSettingsOpen = true; settingsStep = 1;" class="text-gray-500 hover:text-blue-600 transition">
            <i class="fa-solid fa-gear text-xl"></i>
        </button>
    </header>

    <div v-if="!settings.startDate" class="flex-1 flex flex-col items-center justify-center p-6 text-center">
        <i class="fa-regular fa-calendar-days text-6xl text-blue-200 mb-4"></i>
        <h2 class="text-xl font-bold mb-2">開始規劃你的旅程</h2>
        <p class="text-gray-500 mb-6">請先設定航班與日期資訊</p>
        <button @click="isSettingsOpen = true; settingsStep = 1;" class="bg-blue-600 text-white px-6 py-3 rounded-full font-bold shadow-lg active:scale-95 transition">
            前往設定
        </button>
    </div>

    <div v-else class="flex flex-col flex-1 overflow-hidden">
        
        <div class="bg-white border-b shrink-0">
            <div class="flex overflow-x-auto hide-scrollbar px-2">
                <div v-for="(day, index) in daysList" :key="index" 
                     @click="currentDayIndex = index"
                     class="flex-shrink-0 px-4 py-3 text-center cursor-pointer transition-colors relative min-w-[80px]"
                     :class="{'tab-active': currentDayIndex === index, 'text-gray-400': currentDayIndex !== index}">
                    <div class="text-sm font-bold">D{{ index + 1 }}</div>
                    <div class="text-xs">{{ formatDateSimple(day) }}</div>
                </div>
            </div>
        </div>

        <main class="flex-1 overflow-y-auto p-4 pb-24">
            
            <div v-if="currentDayIndex === 0" class="bg-blue-50 border-l-4 border-blue-500 rounded-r-lg p-4 mb-4 card-shadow">
                <div class="flex justify-between items-start">
                    <div>
                        <span class="bg-blue-600 text-white text-xs px-2 py-1 rounded mr-2">去程航班</span>
                        <span class="font-bold text-blue-800">{{ settings.airline }} ({{ settings.flightOutNumber }})</span>
                    </div>
                    <span class="text-xl font-mono font-bold text-blue-600">{{ settings.flightOutTime }}</span>
                </div>
                <div class="mt-2 flex items-center text-sm text-gray-600">
                    <span class="font-bold mr-2">{{ settings.airportOut }}</span>
                    <i class="fa-solid fa-arrow-right mx-2 text-gray-400"></i>
                    <span class="font-bold ml-2">{{ settings.airportIn }}</span>
                </div>
            </div>

            <div v-if="sortedEvents.length === 0 && !isFlightDayOnly" class="text-center py-10 text-gray-400">
                <i class="fa-solid fa-map-location-dot text-4xl mb-3"></i>
                <p>點擊右下角按鈕新增行程</p>
            </div>

            <div v-for="event in sortedEvents" :key="event.id" class="bg-white rounded-lg p-4 mb-3 card-shadow border-l-4 border-orange-400 relative group">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center mb-1">
                            <span class="text-lg font-bold font-mono mr-3 text-gray-800">{{ event.time }}</span>
                            <h3 class="font-bold text-lg text-gray-800">{{ event.location }}</h3>
                        </div>
                        <p v-if="event.note" class="text-sm text-gray-500 mt-1 bg-gray-50 p-2 rounded">{{ event.note }}</p>
                    </div>
                    <button @click="deleteEvent(event.id)" class="text-gray-300 hover:text-red-500 p-2 ml-2">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
                <a :href="getGoogleMapLink(event.location)" target="_blank" class="mt-3 inline-flex items-center text-sm text-blue-500 font-medium hover:underline">
                    <i class="fa-solid fa-location-dot mr-1"></i> 導航去這裡
                </a>
            </div>

            <div v-if="currentDayIndex === daysList.length - 1" class="bg-blue-50 border-l-4 border-blue-500 rounded-r-lg p-4 mt-4 card-shadow">
                <div class="flex justify-between items-start">
                    <div>
                        <span class="bg-blue-600 text-white text-xs px-2 py-1 rounded mr-2">回程航班</span>
                        <span class="font-bold text-blue-800">{{ settings.airline }} ({{ settings.flightReturnNumber }})</span>
                    </div>
                    <span class="text-xl font-mono font-bold text-blue-600">{{ settings.flightReturnTime }}</span>
                </div>
                <div class="mt-2 flex items-center text-sm text-gray-600">
                    <span class="font-bold mr-2">{{ settings.airportIn }}</span>
                    <i class="fa-solid fa-arrow-right mx-2 text-gray-400"></i>
                    <span class="font-bold ml-2">{{ settings.airportOut }}</span>
                </div>
            </div>
        </main>

        <button @click="openAddModal" class="fixed bottom-6 right-6 bg-orange-500 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center text-2xl hover:bg-orange-600 active:scale-90 transition z-20">
            <i class="fa-solid fa-plus"></i>
        </button>
    </div>

    <div v-if="isSettingsOpen" class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4 animate-fade-in">
        <div class="bg-white w-full max-w-md rounded-t-xl sm:rounded-xl p-6 h-[90vh] sm:h-auto overflow-y-auto">
            <h2 class="text-xl font-bold mb-4 border-b pb-2">基礎設定 (步驟 {{ settingsStep }}/3)</h2>
            
            <div class="space-y-4">
                
                <div v-if="settingsStep === 1">
                    <label class="block text-sm font-bold text-gray-600 mb-1">航空公司名稱</label>
                    <input v-model="settings.airline" type="text" class="w-full border rounded p-2 text-lg" placeholder="例如：長榮航空">
                </div>

                <div v-if="settingsStep === 2" class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-600 mb-1">去程日期</label>
                        <input v-model="settings.startDate" type="date" class="w-full border rounded p-2 text-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-600 mb-1">回程日期</label>
                        <input v-model="settings.endDate" type="date" class="w-full border rounded p-2 text-lg">
                    </div>
                </div>

                <div v-if="settingsStep === 3" class="space-y-6">
                    <p class="text-sm text-gray-500 border-b pb-2">請輸入您已經查到的航班資訊，時間使用 **24時制**。</p>
                    
                    <div class="p-3 border rounded-lg bg-red-50/50">
                        <h4 class="font-bold text-red-600 mb-2">去程 Flight Details</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">航班編號</label>
                                <input v-model="settings.flightOutNumber" type="text" class="w-full border rounded p-2 uppercase" placeholder="BR198">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">起飛時間 (24H)</label>
                                <input v-model="settings.flightOutTime" type="time" class="w-full border rounded p-2 text-lg input-time-24h">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">出發機場代號</label>
                                <input v-model="settings.airportOut" type="text" class="w-full border rounded p-2 uppercase" placeholder="TPE">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">抵達機場代號</label>
                                <input v-model="settings.airportIn" type="text" class="w-full border rounded p-2 uppercase" placeholder="NRT">
                            </div>
                        </div>
                    </div>

                    <div class="p-3 border rounded-lg bg-green-50/50">
                        <h4 class="font-bold text-green-600 mb-2">回程 Flight Details</h4>
                        <div class="grid grid-cols-2 gap-4">
                             <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">航班編號</label>
                                <input v-model="settings.flightReturnNumber" type="text" class="w-full border rounded p-2 uppercase" placeholder="BR197">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">起飛時間 (24H)</label>
                                <input v-model="settings.flightReturnTime" type="time" class="w-full border rounded p-2 text-lg input-time-24h">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">出發機場代號</label>
                                <input v-model="settings.airportIn" type="text" class="w-full border rounded p-2 uppercase" placeholder="NRT">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">抵達機場代號</label>
                                <input v-model="settings.airportOut" type="text" class="w-full border rounded p-2 uppercase" placeholder="TPE">
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="mt-8 flex justify-between">
                <button 
                    @click="settingsStep--" 
                    :disabled="settingsStep === 1"
                    :class="{'opacity-50 cursor-not-allowed': settingsStep === 1}"
                    class="flex-none px-4 py-3 border rounded-lg text-gray-500 font-bold transition">
                    <i class="fa-solid fa-arrow-left mr-1"></i> 上一步
                </button>
                
                <div class="flex gap-3">
                    <button v-if="settingsStep < 3" @click="settingsStep++" class="flex-none bg-blue-500 text-white py-3 px-6 rounded-lg font-bold transition hover:bg-blue-600">
                        下一步 <i class="fa-solid fa-arrow-right ml-1"></i>
                    </button>
                    <button v-else @click="saveSettings" class="flex-1 bg-green-600 text-white py-3 px-6 rounded-lg font-bold transition hover:bg-green-700">
                        儲存設定
                    </button>
                    <button v-if="settingsStep === 3" @click="isSettingsOpen = false" class="flex-none px-4 py-3 border rounded-lg text-gray-500">取消</button>
                </div>
            </div>
            
        </div>
    </div>

    <div v-if="isAddModalOpen" class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div class="bg-white w-full max-w-md rounded-t-xl sm:rounded-xl p-6 animate-slide-up">
            <h2 class="text-xl font-bold mb-4">新增行程 (D{{ currentDayIndex + 1 }})</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-1">起始時間 (**24時制**)</label>
                    <input v-model="newEvent.time" type="time" class="w-full border rounded p-2 text-lg input-time-24h">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-1">目的地/景點</label>
                    <input v-model="newEvent.location" type="text" class="w-full border rounded p-2" placeholder="例如：淺草寺">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-1">備註</label>
                    <textarea v-model="newEvent.note" class="w-full border rounded p-2 h-20" placeholder="筆記、訂位代號等..."></textarea>
                </div>
            </div>
            <div class="mt-6 flex gap-3">
                <button @click="addEvent" class="flex-1 bg-orange-500 text-white py-3 rounded-lg font-bold">加入行程</button>
                <button @click="isAddModalOpen = false" class="flex-none px-4 py-3 border rounded-lg text-gray-500">取消</button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, watch, onMounted } = Vue;

    createApp({
        setup() {
            // 資料狀態
            const isSettingsOpen = ref(false);
            const settingsStep = ref(1); // 新增：用於控制設定流程
            const isAddModalOpen = ref(false);
            const currentDayIndex = ref(0);
            
            const settings = ref({
                airline: '',
                // 新增航班編號欄位
                flightOutNumber: '', 
                flightReturnNumber: '',
                // 機場代號/時間全部移到 Step 3
                airportOut: '',
                airportIn: '',
                startDate: '',
                endDate: '',
                flightOutTime: '', // 24小時制
                flightReturnTime: '' // 24小時制
            });

            const events = ref([]); // 結構: { id, dayIndex, time, location, note }
            const newEvent = ref({ time: '09:00', location: '', note: '' }); // 預設時間為 09:00 (24H)

            // 初始化讀取 LocalStorage
            onMounted(() => {
                const savedSettings = localStorage.getItem('travel_settings');
                const savedEvents = localStorage.getItem('travel_events');
                if (savedSettings) settings.value = JSON.parse(savedSettings);
                if (savedEvents) events.value = JSON.parse(savedEvents);
            });

            // 儲存監聽
            watch(settings, (newVal) => localStorage.setItem('travel_settings', JSON.stringify(newVal)), { deep: true });
            watch(events, (newVal) => localStorage.setItem('travel_events', JSON.stringify(newVal)), { deep: true });

            // 計算所有旅遊日期
            const daysList = computed(() => {
                if (!settings.value.startDate || !settings.value.endDate) return [];
                const start = new Date(settings.value.startDate);
                const end = new Date(settings.value.endDate);
                const list = [];
                for (let dt = new Date(start); dt <= end; dt.setDate(dt.getDate() + 1)) {
                    list.push(new Date(dt));
                }
                return list;
            });

            // 篩選並排序當天行程 (依照 24小時制 time 排序)
            const sortedEvents = computed(() => {
                return events.value
                    .filter(e => e.dayIndex === currentDayIndex.value)
                    .sort((a, b) => a.time.localeCompare(b.time));
            });

            const isFlightDayOnly = computed(() => {
                const isD1 = currentDayIndex.value === 0;
                const isLast = currentDayIndex.value === daysList.value.length - 1;
                return (isD1 || isLast) && sortedEvents.value.length === 0;
            });

            // 功能函數
            const saveSettings = () => {
                 if(!settings.value.airline || !settings.value.startDate || !settings.value.endDate) {
                    alert("請完成所有步驟的必要欄位！");
                    return;
                }
                isSettingsOpen.value = false;
                settingsStep.value = 1; // 儲存完畢後重置步驟
                // 如果切換日期導致當前頁面索引超出範圍，重置為 D1
                if(currentDayIndex.value >= daysList.value.length) currentDayIndex.value = 0;
            };

            const openAddModal = () => {
                // 開啟時預設時間為早上 9 點 (24H)
                newEvent.value = { time: '09:00', location: '', note: '' }; 
                isAddModalOpen.value = true;
            };

            const addEvent = () => {
                // 檢查時間格式是否為 24H 格式 (HH:MM)
                const timePattern = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
                if (!newEvent.value.location || !timePattern.test(newEvent.value.time)) {
                    alert("請填寫地點，並確保時間為 24時制 (例如 14:30)");
                    return;
                }
                events.value.push({
                    id: Date.now(),
                    dayIndex: currentDayIndex.value,
                    ...newEvent.value
                });
                isAddModalOpen.value = false;
            };

            const deleteEvent = (id) => {
                if(confirm("確定要刪除這個行程嗎？")) {
                    events.value = events.value.filter(e => e.id !== id);
                }
            };

            const getGoogleMapLink = (location) => {
                // Google Maps 搜尋連結
                return `https://www.google.com/maps/search/?api=1&query=$${encodeURIComponent(location)}`;
            };

            const formatDateSimple = (dateObj) => {
                const month = dateObj.getMonth() + 1;
                const date = dateObj.getDate();
                const days = ['日', '一', '二', '三', '四', '五', '六'];
                const dayName = days[dateObj.getDay()];
                return `${month}/${date} (${dayName})`;
            };

            return {
                isSettingsOpen, settingsStep, isAddModalOpen, currentDayIndex,
                settings, daysList, sortedEvents, newEvent, isFlightDayOnly,
                saveSettings, openAddModal, addEvent, deleteEvent, 
                getGoogleMapLink, formatDateSimple
            };
        }
    }).mount('#app');
</script>

</body>
</html>
